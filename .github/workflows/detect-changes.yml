name: Detect Changed Modules

on:
  workflow_call:
    outputs:
      modules:
        description: 'JSON array of changed modules'
        value: ${{ jobs.detect.outputs.modules }}
      has-changes:
        description: 'Whether any modules changed'
        value: ${{ jobs.detect.outputs.has-changes }}

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      modules: ${{ steps.set-matrix.outputs.modules }}
      has-changes: ${{ steps.set-matrix.outputs.has-changes }}
      test-all: ${{ steps.set-matrix.outputs.test-all }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Detect changed modules
        id: set-matrix
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE_SHA=${{ github.event.pull_request.base.sha }}
          else
            BASE_SHA=HEAD~1
          fi
          
          echo "ğŸ” Comparing $BASE_SHA with HEAD"
          
          # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡
          CHANGED_FILES=$(git diff --name-only $BASE_SHA HEAD)
          echo "ğŸ“ Changed files:"
          echo "$CHANGED_FILES"
          echo ""
          
          # build.gradle íŒŒì¼ì´ ìˆëŠ” ë””ë ‰í† ë¦¬ë¥¼ ëª¨ë“ˆë¡œ ì¸ì‹
          # ë³€ê²½ëœ íŒŒì¼ì—ì„œ í•´ë‹¹ íŒŒì¼ì´ ì†í•œ ëª¨ë“ˆ ì°¾ê¸°
          echo "$CHANGED_FILES" | while read -r file; do
            if [ -z "$file" ]; then
              continue
            fi
          
            # settings/** ë””ë ‰í† ë¦¬ ì œì™¸
            if [[ "$file" == settings/* ]]; then
              echo "â­ï¸  Skipping settings file: $file"
              continue
            fi
          
            # íŒŒì¼ì˜ ë””ë ‰í† ë¦¬ ê²½ë¡œ ì¶”ì¶œ
            dir=$(dirname "$file")
          
            # í•´ë‹¹ ë””ë ‰í† ë¦¬ì—ì„œ ìƒìœ„ë¡œ ì˜¬ë¼ê°€ë©´ì„œ build.gradle ì°¾ê¸°
            current_dir="$dir"
            while [ "$current_dir" != "." ] && [ "$current_dir" != "/" ]; do
              # build.gradle ë˜ëŠ” build.gradle.kts ì¡´ì¬ í™•ì¸
              if [ -f "$current_dir/build.gradle" ] || [ -f "$current_dir/build.gradle.kts" ]; then
                # íŒŒì¼ ê²½ë¡œë¥¼ Gradle ê²½ë¡œë¡œ ë³€í™˜: common/common-app â†’ :common:common-app
                gradle_path=":${current_dir//\//:}"
                echo "$gradle_path" >> /tmp/changed_modules.txt
                break
              fi
          
              # ìƒìœ„ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
              current_dir=$(dirname "$current_dir")
            done
          done
          
          echo "ğŸ¯ Changed modules:"
          echo "$CHANGED_MODULES"
          
          if [ -f /tmp/changed_modules.txt ]; then
            CHANGED_MODULES_UNIQUE=$(cat /tmp/changed_modules.txt | sort -u)
          
            echo "ğŸ¯ Changed modules (Gradle format):"
            echo "$CHANGED_MODULES_UNIQUE"
          
            # JSON ë°°ì—´ë¡œ ë³€í™˜
            MODULES_JSON=$(echo "$CHANGED_MODULES_UNIQUE" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "has-changes=true" >> $GITHUB_OUTPUT
            echo "modules=$MODULES_JSON" >> $GITHUB_OUTPUT
            echo "âœ… Changed modules JSON: $MODULES_JSON"
          else
            echo "â„¹ï¸  No module changes detected"
            echo "has-changes=false" >> $GITHUB_OUTPUT
            echo "modules=[]" >> $GITHUB_OUTPUT
          fi
          
          # ì„ì‹œ íŒŒì¼ ì •ë¦¬
          rm -f /tmp/changed_modules.txt
